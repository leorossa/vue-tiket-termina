# Инструкция по созданию редактируемых услуг (Editable Services)

## Общая информация

Данная инструкция описывает процесс создания редактируемых услуг в системе TicketTerminal-API, включая все необходимые зависимости, источники данных и требуемые параметры.

## Карта зависимостей при создании услуги

```
┌─────────────────────┐     ┌────────────────────┐     ┌─────────────────────┐
│  ServiceController  │────▶│   ServiceService   │────▶│  ServiceRepository  │
└─────────────────────┘     └────────────────────┘     └─────────────────────┘
          │                         │                           │
          │                         │                           │
          ▼                         ▼                           ▼
┌─────────────────────┐     ┌────────────────────┐     ┌─────────────────────┐
│  ServiceCreateDto   │     │   ServiceEntity    │     │   ServiceMapper     │
└─────────────────────┘     └────────────────────┘     └─────────────────────┘
          │                         │                           │
          │                         │                           │
          ▼                         ▼                           ▼
┌─────────────────────┐     ┌────────────────────┐     ┌─────────────────────┐
│    VisitObjectDto   │────▶│ VisitObjectEntity  │◀────│  VisitObjectMapper  │
└─────────────────────┘     └────────────────────┘     └─────────────────────┘
          │                         │                           │
          │                         │                           │
          ▼                         ▼                           ▼
┌─────────────────────┐     ┌────────────────────┐     ┌─────────────────────┐
│ CategoryVisitorDto  │────▶│CategoryVisitorEntity│◀────│CategoryVisitorMapper│
└─────────────────────┘     └────────────────────┘     └─────────────────────┘
          │                         │                           │
          │                         │                           │
          ▼                         ▼                           ▼
┌─────────────────────┐     ┌────────────────────┐     ┌─────────────────────┐
│      PriceDto       │────▶│    PriceEntity     │◀────│     PriceMapper     │
└─────────────────────┘     └────────────────────┘     └─────────────────────┘
```

## Источники данных при создании услуги

### 1. Основные данные услуги

| Поле в ServiceCreateDto | Описание | Источник данных |
|------------------------|----------|----------------|
| serviceName | Название услуги | Пользовательский ввод |
| description | Описание услуги | Пользовательский ввод |
| cost | Базовая стоимость | Пользовательский ввод |
| activeKindId | Идентификатор типа активности | Выбор из предопределенного списка |
| isNeedVisitDate | Требуется ли дата посещения | Чекбокс в интерфейсе |
| isNeedVisitTime | Требуется ли время посещения | Чекбокс в интерфейсе |
| dtBegin | Дата начала действия услуги | Выбор из календаря |
| dtEnd | Дата окончания действия услуги | Выбор из календаря |
| proCultureIdentifier | Идентификатор в системе PRO.Культура | Пользовательский ввод |
| isPROCultureChecked | Проверено ли в PRO.Культура | Чекбокс в интерфейсе |
| isDisableEditVisitObject | Запрет редактирования объекта посещения | Чекбокс в интерфейсе |
| isDisableEditVisitor | Запрет редактирования посетителя | Чекбокс в интерфейсе |
| isVisitObjectUseForCost | Использовать объект посещения для расчета стоимости | Чекбокс в интерфейсе |
| isCategoryVisitorUseForCost | Использовать категорию посетителя для расчета стоимости | Чекбокс в интерфейсе |
| isVisitorCountUseForCost | Использовать количество посетителей для расчета стоимости | Чекбокс в интерфейсе |
| isUseOneCategory | Использовать только одну категорию | Чекбокс в интерфейсе |

### 2. Объекты посещения (VisitObject)

| Поле в VisitObjectDto | Описание | Источник данных |
|----------------------|----------|----------------|
| visitObjectId | Идентификатор объекта посещения | Выбор из существующих объектов |
| visitObjectName | Название объекта посещения | Автоматически из выбранного объекта |
| isRequire | Обязательность объекта | Чекбокс в интерфейсе |
| groupVisitObjectId | Идентификатор группы объектов | Автоматически из выбранного объекта |

### 3. Категории посетителей (CategoryVisitor)

| Поле в CategoryVisitorDto | Описание | Источник данных |
|--------------------------|----------|----------------|
| categoryVisitorId | Идентификатор категории | Выбор из существующих категорий |
| categoryVisitorName | Название категории | Автоматически из выбранной категории |
| requireVisitorCount | Требуемое количество посетителей | Пользовательский ввод |
| groupCategoryVisitorId | Идентификатор группы категорий | Автоматически из выбранной категории |

### 4. Цены (Price)

| Поле в PriceDto | Описание | Источник данных |
|----------------|----------|----------------|
| visitObjectId | Идентификатор объекта посещения | Выбор из связанных объектов |
| categoryVisitorId | Идентификатор категории посетителя | Выбор из связанных категорий |
| cost | Стоимость | Пользовательский ввод |
| serviceId | Идентификатор услуги | Автоматически при сохранении |

## Процесс создания услуги

### Шаг 1: Подготовка данных на клиенте

1. Получить список всех объектов посещения через `GET /VisitObject`
2. Получить список всех категорий посетителей через `GET /CategoryVisitors`
3. Заполнить форму создания услуги с основными данными
4. Выбрать необходимые объекты посещения и отметить их как обязательные (isRequire)
5. Выбрать категории посетителей и указать требуемое количество (requireVisitorCount)
6. Для каждой комбинации объекта посещения и категории посетителя указать стоимость

### Шаг 2: Отправка запроса на создание

1. Сформировать объект `ServiceCreateDto` со всеми необходимыми данными
2. Отправить POST-запрос на эндпоинт `/Service/Create`

### Шаг 3: Обработка на сервере

1. `ServiceController` принимает запрос и передает данные в `ServiceService`
2. `ServiceService` создает новую сущность `ServiceEntity` и заполняет ее данными из DTO
3. Сохраняет сущность в базе данных через `ServiceRepository`
4. Привязывает выбранные объекты посещения к услуге
5. Создает записи цен для каждой комбинации объекта посещения и категории посетителя
6. Формирует и возвращает расширенный DTO `EditableServiceDto`

## Важные зависимости и связи

1. **Услуга (Service)** - центральная сущность, содержащая основные параметры
2. **Объект посещения (VisitObject)** - место, где оказывается услуга
3. **Категория посетителя (CategoryVisitor)** - тип посетителя (взрослый, ребенок, льготник и т.д.)
4. **Цена (Price)** - связующая сущность, определяющая стоимость для конкретной комбинации услуги, объекта и категории

## Особенности и ограничения

1. При создании услуги можно указать базовую стоимость (`cost`), но фактическая цена определяется через сущность `Price`
2. Если `isVisitObjectUseForCost = true`, то стоимость зависит от выбранного объекта посещения
3. Если `isCategoryVisitorUseForCost = true`, то стоимость зависит от категории посетителя
4. Если `isVisitorCountUseForCost = true`, то стоимость умножается на количество посетителей
5. Если `isUseOneCategory = true`, то можно выбрать только одну категорию посетителя

## Чекбоксы и параметры при создании услуги

### Основные параметры

- [ ] isNeedVisitDate - Требуется указание даты посещения
- [ ] isNeedVisitTime - Требуется указание времени посещения
- [ ] isPROCultureChecked - Проверено в системе PRO.Культура
- [ ] isDisableEditVisitObject - Запретить редактирование объекта посещения
- [ ] isDisableEditVisitor - Запретить редактирование посетителя

### Параметры расчета стоимости

- [ ] isVisitObjectUseForCost - Использовать объект посещения для расчета стоимости
- [ ] isCategoryVisitorUseForCost - Использовать категорию посетителя для расчета стоимости
- [ ] isVisitorCountUseForCost - Использовать количество посетителей для расчета стоимости
- [ ] isUseOneCategory - Использовать только одну категорию

## Примечания по реализации

1. При создании услуги важно корректно настроить все чекбоксы, так как они влияют на логику работы системы
2. Для каждой услуги необходимо создать хотя бы одну запись в таблице цен
3. Если услуга не привязана к конкретному объекту посещения, то поле `visitObjectId` в `PriceDto` может быть null
4. Если услуга не привязана к конкретной категории посетителя, то поле `categoryVisitorId` в `PriceDto` может быть null
